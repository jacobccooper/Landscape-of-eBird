---
title: "Geography of Birding in the United States"
author: "Jacob C. Cooper"
date: "August 28, 2019"
output: pdf_document
urlcolor: blue
---

# Introduction

eBird data was provided by Ian Davies in February 2019. All other data were gleaned from Wikipedia in February 2019. GDP was taken from the [Wikipedia page on GDP](https://en.wikipedia.org/wiki/List_of_United_States_counties_by_per_capita_income). These codes also include a "distance to line" function that was adopted from a [StackOverflow discussion](https://stackoverflow.com/questions/35194048/using-r-how-to-calculate-the-distance-from-one-point-to-a-line).

First, we will load required packages.

```{r}
library(ggplot2)
```

Note that the data were aligned manually in a spreadsheet to ensure all county names were consistent.

# Analyses

## Load the data

First, we need to load the data table.

```{r,echo=F}
## Edit this before running!

## formatted for Linux

filepath="~/Path/to/folder"
```
```{r}
x=read.csv(paste0(filepath,"GDP-eBird_data.csv"))

head(x)
```

## GDP Per Capita

First, we can compare the per capita income of each individual area to the number of checklists accumulated in that area.

```{r}
# add column for natural log of checklist count
x$logcheck=log(x$eBird_count)

# add column for natural log of GDP
x$logGDP=log(x$PerCapitaIncome)

# get regression equation
eq.x.1=lm(x$logcheck~x$logGDP)
a.1.1=round(coef(eq.x.1)[1],2)#intercept
b.1.1=round(coef(eq.x.1)[2],6)#slope
r.x.1=round(summary(eq.x.1)$r.squared,2)
a.err.1=round(summary(eq.x.1)$coefficients[3],2)
b.err.1=round(summary(eq.x.1)$coefficients[4],6)

# create plot
a=ggplot(aes(x=logGDP,y=logcheck),data=x)
b=geom_point()
c=geom_smooth(method=lm)
d=theme_classic()
d.1=theme(axis.title = element_text(face="bold",size=20),
          axis.text = element_text(size=10,face="bold"),
          legend.title = element_blank(),
          legend.text = element_text(size=14,face="bold"))

e=labs(x='Log of GDP per Capita',y='Log of Checklist Count')
p=annotate("text",label=paste0('Relationship: y=(',b.1.1,'x +/- ',2*b.err.1,') + (',a.1.1," +/- ",2*a.err.1,')',', r^2 = ',r.x.1),x=10,y=15)
#p.1=annotate("text",label=paste0('P. villosus: y=(',b.1,'x +/- ',2*b.err,') + (',a.1," +/- ",2*a.err,')',', r^2 = ',r.x),x=0,y=90)
Fig3=a+b+c+d+e+d.1+p

plot(Fig3)
```

There is a fairly amorphous cloud of points, and that the relationship within the data is not extremely strong ($R^{2}=0.22$).

We can try to clip out extreme variation to see if this improves the fit.

```{r}
subset1=which(x$logcheck<8&x$logGDP>10.5)
subset2=which(x$logcheck>8&x$logGDP<9.5)

subset=x[-c(subset1,subset2),]

eq.x.1=lm(subset$logcheck~subset$logGDP)
a.1.1=round(coef(eq.x.1)[1],2)#intercept
b.1.1=round(coef(eq.x.1)[2],6)#slope
r.x.1=round(summary(eq.x.1)$r.squared,2)
a.err.1=round(summary(eq.x.1)$coefficients[3],2)
b.err.1=round(summary(eq.x.1)$coefficients[4],6)

a=ggplot(aes(x=logGDP,y=logcheck),data=subset)
b=geom_point()
c=geom_smooth(method=lm)
d=theme_classic()
d.1=theme(axis.title = element_text(face="bold",size=20),
          axis.text = element_text(size=10,face="bold"),
          legend.title = element_blank(),
          legend.text = element_text(size=14,face="bold"))

e=labs(x='Log of GDP per Capita',y='Log of Checklist Count')
p=annotate("text",label=paste0('Relationship: y=(',b.1.1,'x +/- ',2*b.err.1,') + (',a.1.1," +/- ",2*a.err.1,')',', r^2 = ',r.x.1),x=10,y=15)
#p.1=annotate("text",label=paste0('P. villosus: y=(',b.1,'x +/- ',2*b.err,') + (',a.1," +/- ",2*a.err,')',', r^2 = ',r.x),x=0,y=90)
Fig3=a+b+c+d+e+d.1+p

plot(Fig3)
```

It fits better, but not by a lot. There is still a lot of uncertainty in the cloud center. Let's look at the point density to determine what may be causing this.

```{r}
a=ggplot(aes(x=logGDP,y=logcheck),data=subset)
b=stat_density_2d(aes(fill=..level..),geom="polygon",colour="white")
c=geom_smooth(method=lm)
d=theme_classic()
d.1=theme(axis.title = element_text(face="bold",size=20),
          axis.text = element_text(size=10,face="bold"),
          legend.title = element_blank(),
          legend.text = element_text(size=14,face="bold"))

e=labs(x='Log of GDP per Capita',y='Log of Checklist Count')
#p=annotate("text",label=paste0('Relationship: y=(',b.1.1,'x +/- ',2*b.err.1,') + (',a.1.1," +/- ",2*a.err.1,')',', r^2 = ',r.x.1),x=10,y=15)
#p.1=annotate("text",label=paste0('P. villosus: y=(',b.1,'x +/- ',2*b.err,') + (',a.1," +/- ",2*a.err,')',', r^2 = ',r.x),x=0,y=90)
Fig3=a+b+c+d+e+d.1

paste0('Relationship: y=(',b.1.1,'x +/- ',2*b.err.1,') + (',
       a.1.1," +/- ",2*a.err.1,')',', r^2 = ',r.x.1)
plot(Fig3)
```

We have a fit of $R^{2}=0.24$, which is better but not by a lot.

As is visible in the density plot, the tails of the distribution are dragging it down and there is a secondary area of increased density on the lower part of the cluster. A closer look at this sub-group reveals the following:

```{r}
#Restrict GDP
sub2=subset[subset$logGDP>10&subset$logGDP<10.25,]

#Restrict lists
sub2=sub2[sub2$logcheck<7&sub2$logcheck>6,]

summary(sub2)
```

This secondary cluster is made up of states with large agricultural areas - Nebraska, Iowa, Texas, South Dakota. Specifically, these are agricultural regions with similar incomes and similar low-level consistent checklist output. A look at each area by region will provide more insight.

### Create official GDP plot

```{r}
# get regression equation
eq.x.1=lm(x$logcheck~x$logGDP)
a.1.1=round(coef(eq.x.1)[1],2)#intercept
b.1.1=round(coef(eq.x.1)[2],6)#slope
r.x.1=round(summary(eq.x.1)$r.squared,2)
a.err.1=round(summary(eq.x.1)$coefficients[3],2)
b.err.1=round(summary(eq.x.1)$coefficients[4],6)

# create plot
a=ggplot(aes(x=logGDP,y=logcheck),data=x)
b=stat_density_2d(aes(fill=..level..),geom="polygon",colour="white")
c=geom_smooth(method=lm)
d=theme_classic()
d.1=theme(axis.title = element_text(face="bold",size=20),
          axis.text = element_text(size=10,face="bold"),
          legend.title = element_blank(),
          legend.text = element_text(size=14,face="bold"))

e=labs(x='Log of GDP per Capita',y='Log of Checklist Count')
Fig3=a+b+c+d+e+d.1

plot(Fig3)
paste0('Relationship: y=(',b.1.1,'x +/- ',2*b.err.1,') + (',
       a.1.1," +/- ",2*a.err.1,')',', r^2 = ',r.x.1)

ggsave(plot=Fig3,filename=paste0(filepath,"GDP-vs-Checklist_density.png"),dpi=400)
```

There is a fairly amorphous cloud of points, and that the relationship within the data is not extremely strong ($R^{2}=0.22$).

## Regional Comparisons of GDP per Capita

The GDP exploration revealed clear patterns in terms of region. I will now subdivide the states by Census REgions and Divisions as defined by the USA government; note that at the more local scale I exclude Alaska and Hawaii given their geographic uniqueness.

```{r}
x$Region="undefined"
x$Subregion="undefined"

#define subregions

NewEngland=which(as.character(x$State)=="Connecticut"|
                   as.character(x$State)=="Massachusetts"|
                   as.character(x$State)=="Maine"|
                   as.character(x$State)=="New Hampshire"|
                   as.character(x$State)=="Rhode Island"|
                   as.character(x$State)=="Vermont")

MidAtlantic=which(as.character(x$State)=="New York"|
                    as.character(x$State)=="New Jersey"|
                    as.character(x$State)=="Pennsylvania")

ENCentral=which(as.character(x$State)=="Ohio"|
                  as.character(x$State)=="Michigan"|
                  as.character(x$State)=="Indiana"|
                  as.character(x$State)=="Illinois"|
                  as.character(x$State)=="Wisconsin")

WNCentral=which(as.character(x$State)=="Minnesota"|
                  as.character(x$State)=="Iowa"|
                  as.character(x$State)=="Missouri"|
                  as.character(x$State)=="Kansas"|
                  as.character(x$State)=="Nebraska"|
                  as.character(x$State)=="South Dakota"|
                  as.character(x$State)=="North Dakota")

SAtlantic=which(as.character(x$State)=="Delaware"|
                  as.character(x$State)=="Maryland"|
                  as.character(x$State)=="District of Columbia"|
                  as.character(x$State)=="West Virginia"|
                  as.character(x$State)=="Virginia"|
                  as.character(x$State)=="South Carolina"|
                  as.character(x$State)=="North Carolina"|
                  as.character(x$State)=="Georgia"|
                  as.character(x$State)=="Florida")

ESCentral=which(as.character(x$State)=="Kentucky"|
                  as.character(x$State)=="Tennessee"|
                  as.character(x$State)=="Mississippi"|
                  as.character(x$State)=="Alabama")

WSCentral=which(as.character(x$State)=="Arkansas"|
                  as.character(x$State)=="Louisiana"|
                  as.character(x$State)=="Oklahoma"|
                  as.character(x$State)=="Texas")

Mountain=which(as.character(x$State)=="Montana"|
                 as.character(x$State)=="Idaho"|
                 as.character(x$State)=="Wyoming"|
                 as.character(x$State)=="Colorado"|
                 as.character(x$State)=="Utah"|
                 as.character(x$State)=="Nevada"|
                 as.character(x$State)=="Arizona"|
                 as.character(x$State)=="New Mexico")

Pacific=which(as.character(x$State)=="Washington"|
                as.character(x$State)=="Oregon"|
                as.character(x$State)=="California")

x$Subregion[NewEngland]="New England"
x$Subregion[MidAtlantic]="Middle Atlantic"
x$Subregion[SAtlantic]="South Atlantic"
x$Subregion[ESCentral]="East South Central"
x$Subregion[WSCentral]="West South Central"
x$Subregion[ENCentral]="East North Central"
x$Subregion[WNCentral]="West North Central"
x$Subregion[Mountain]="Mountain"
x$Subregion[Pacific]="Pacific"

x$Region[c(NewEngland,MidAtlantic)]="Northeast"
x$Region[c(SAtlantic,ESCentral,WSCentral)]="South"
x$Region[c(ENCentral,WNCentral)]="Midwest"
x$Region[c(Mountain,Pacific)]="West"

x$Region=as.factor(x$Region)
x$Subregion=as.factor(x$Subregion)
```

First, by major region:

```{r}
regions=unique(x$Region) #remove undefined

for(i in 1:length(regions)){
  subset.x=x[x$Region==regions[i],]
  subset.x=na.omit(subset.x)
    
  eq.x.1=lm(subset.x$logcheck~subset.x$logGDP)
  a.1.1=round(coef(eq.x.1)[1],2)#intercept
  b.1.1=round(coef(eq.x.1)[2],6)#slope
  r.x.1=round(summary(eq.x.1)$r.squared,2)
  a.err.1=round(summary(eq.x.1)$coefficients[3],2)
  b.err.1=round(summary(eq.x.1)$coefficients[4],6)
  
  xval=min(subset.x$logGDP)+(max(subset.x$logGDP)-min(subset.x$logGDP))/2
  yval=1+max(subset.x$logcheck)
  
  a=ggplot(aes(x=logGDP,y=logcheck),data=subset.x)
  b=geom_point()
  c=geom_smooth(method=lm)
  d=theme_classic()
  d.1=theme(axis.title = element_text(face="bold",size=20),
            axis.text = element_text(size=10,face="bold"),
            legend.title = element_blank(),
            legend.text = element_text(size=14,face="bold"))
  
  e=labs(x='Log of GDP per Capita',y='Log of Checklist Count')
  w2=ggtitle(regions[i])
  
  Fig3=a+b+c+d+e+d.1+w2

  ggsave(plot=Fig3,filename=paste0(filepath,"GDP-vs-Checklist_region_",regions[i],".png"),dpi=400)
  
  plot(Fig3)
  print(paste0('Relationship: ',regions[i],' y=(',round(b.1.1,3),'x +/- ',round(2*b.err.1,3),
                                 ') + (',round(a.1.1,3)," +/- ",round(2*a.err.1,3),')',
                                 ', r^2 = ',round(r.x.1,2)))
  #What are the biggest residual outliers?
  
  dist2d=function(a1,a2,a3){
    v1=a2-a3
    v2=a1-a2
    m=cbind(v1,v2)
    d=det(m)/sqrt(sum(v1*v1))
    return(d)
  }
  
  a2=c(0,a.1.1)
  val.test=(b.1.1*20)+a.1.1
  a3=c(20,val.test)

  subset.x$RDistance=0
  
  for(j in 1:nrow(subset.x)){
    a1.x=subset.x$logGDP[j]
    a1.y=subset.x$logcheck[j]
    a1=c(a1.x,a1.y)
    subset.x$RDistance[j]=dist2d(a1,a2,a3)
  }
  
  mu=mean(subset.x$RDistance)
  sd.x=sd(subset.x$RDistance)
  
  hi=qnorm(p=0.975,mean=mu,sd=sd.x)
  lo=qnorm(p=0.025,mean=mu,sd=sd.x)
  
  lows=subset.x[subset.x$RDistance<lo,]
  his=subset.x[subset.x$RDistance>hi,]
  
  lows=lows[order(lows$RDistance,decreasing=F),]
  his=his[order(his$RDistance,decreasing=T),]
  
  #Note that somehow hi and low are switched
  
  print("Higher than Average Counties")
  print(lows[,c("County","State","PerCapitaIncome","eBird_count")])
  
  print("Lower than Average Counties")
  print(his[,c("County","State","PerCapitaIncome","eBird_count")])
}
```

Second, by subregion:

```{r}
subregions=unique(x$Subregion)

for(i in 1:length(subregions)){

  subset.x=x[x$Subregion==subregions[i],]
  #subset.x=na.omit(subset.x)
  
  eq.x.1=lm(subset.x$logcheck~subset.x$logGDP)
  a.1.1=round(coef(eq.x.1)[1],2)#intercept
  b.1.1=round(coef(eq.x.1)[2],6)#slope
  r.x.1=round(summary(eq.x.1)$r.squared,2)
  a.err.1=round(summary(eq.x.1)$coefficients[3],2)
  b.err.1=round(summary(eq.x.1)$coefficients[4],6)

  xval=min(subset.x$logGDP)+(max(subset.x$logGDP)-min(subset.x$logGDP))/2
  yval=1+max(subset.x$logcheck)
  
  a=ggplot(aes(x=logGDP,y=logcheck),data=subset.x)
  b=geom_point()
  c=geom_smooth(method=lm)
  d=theme_classic()
  d.1=theme(axis.title = element_text(face="bold",size=20),
            axis.text = element_text(size=10,face="bold"),
            legend.title = element_blank(),
            legend.text = element_text(size=14,face="bold"))
  w2=ggtitle(subregions[i])
  
  e=labs(x='Log of GDP per Capita',y='Log of Checklist Count')
  
  Fig3=a+b+c+d+e+d.1+w2
  ggsave(plot=Fig3,filename=paste0(filepath,"GDP-vs-Checklist_subregion_",subregions[i],".png"),dpi=400)

  plot(Fig3)
  
  print(paste0('Relationship: ',subregions[i],' y=(',
               round(b.1.1,3),'x +/- ',
               round(2*b.err.1,3),') + (',round(a.1.1,3),
               " +/- ",round(2*a.err.1,3),')',', r^2 = ',round(r.x.1,2)))
}
```

Interestingly, some areas show this connection a lot more strongly than others. This is likely related to more even birding effort in areas that are topographically heterogeneous and offering different bird communities in different regions. However, the South Atlantic has this diversity but still seems to strongly show birders focusing on wealthier counties.

# Population Analyses

```{r}
x$logpop=log(x$Population)

# get regression equation
eq.x.1=lm(x$logcheck~x$logpop)
a.1.1=round(coef(eq.x.1)[1],2)#intercept
b.1.1=round(coef(eq.x.1)[2],6)#slope
r.x.1=round(summary(eq.x.1)$r.squared,2)
a.err.1=round(summary(eq.x.1)$coefficients[3],2)
b.err.1=round(summary(eq.x.1)$coefficients[4],6)

# create plot
a=ggplot(aes(x=logpop,y=logcheck),data=x)
b=stat_density_2d(aes(fill=..level..),geom="polygon",colour="white")
c=geom_smooth(method=lm)
d=theme_classic()
d.1=theme(axis.title = element_text(face="bold",size=20),
          axis.text = element_text(size=10,face="bold"),
          legend.title = element_blank(),
          legend.text = element_text(size=14,face="bold"))

e=labs(x='Log of Population',y='Log of Checklist Count')
Fig3=a+b+c+d+e+d.1
ggsave(plot=Fig3,filename=paste0(filepath,"Pop-vs-Checklist_density.png"),dpi=400)

plot(Fig3)

paste0('Relationship: y=(',b.1.1,'x +/- ',2*b.err.1,') + (',
       a.1.1," +/- ",2*a.err.1,')',', r^2 = ',r.x.1)
```

There is a fairly amorphous cloud of points, but the relationship is stronger than for GDP ($R^{2}=0.48$).

We can try to clip out extreme variation to see if this improves the fit.

It fits better, but not by a lot. There is still a lot of uncertainty in the cloud center. Let's look at the point density to determine what may be causing this.

## Major regions

We are now going to repeat these analyses but with respect to population.

First, by major region:

```{r}
regions=unique(x$Region) #remove undefined

for(i in 1:length(regions)){
  subset.x=x[x$Region==regions[i],]
  #subset.x=na.omit(subset.x)
    
  eq.x.1=lm(subset.x$logcheck~subset.x$logpop)
  a.1.1=round(coef(eq.x.1)[1],2)#intercept
  b.1.1=round(coef(eq.x.1)[2],6)#slope
  r.x.1=round(summary(eq.x.1)$r.squared,2)
  a.err.1=round(summary(eq.x.1)$coefficients[3],2)
  b.err.1=round(summary(eq.x.1)$coefficients[4],6)
  
  xval=min(subset.x$logpop)+(max(subset.x$logpop)-min(subset.x$logpop))/2
  yval=1+max(subset.x$logcheck)
  
  a=ggplot(aes(x=logpop,y=logcheck),data=subset.x)
  b=geom_point()
  c=geom_smooth(method=lm)
  d=theme_classic()
  d.1=theme(axis.title = element_text(face="bold",size=20),
            axis.text = element_text(size=10,face="bold"),
            legend.title = element_blank(),
            legend.text = element_text(size=14,face="bold"))
  
  e=labs(x='Log of Population',y='Log of Checklist Count')
  w2=ggtitle(regions[i])
  
  Fig3=a+b+c+d+e+d.1+w2
  ggsave(plot=Fig3,filename=paste0(filepath,"Pop-vs-Checklist_region_",regions[i],".png"),dpi=400)

  plot(Fig3)
  print(paste0('Relationship: ',regions[i],' y=(',round(b.1.1,3),'x +/- ',round(2*b.err.1,3),
                                 ') + (',round(a.1.1,3)," +/- ",round(2*a.err.1,3),')',
                                 ', r^2 = ',round(r.x.1,2)))
  
  #What are the biggest residual outliers?
  
  dist2d=function(a1,a2,a3){
    v1=a2-a3
    v2=a1-a2
    m=cbind(v1,v2)
    d=det(m)/sqrt(sum(v1*v1))
    return(d)
  }
  
  a2=c(0,a.1.1)
  val.test=(b.1.1*20)+a.1.1
  a3=c(20,val.test)

  subset.x$RDistance=0
  
  for(j in 1:nrow(subset.x)){
    a1.x=subset.x$logpop[j]
    a1.y=subset.x$logcheck[j]
    a1=c(a1.x,a1.y)
    subset.x$RDistance[j]=dist2d(a1,a2,a3)
  }
  
  mu=mean(subset.x$RDistance)
  sd.x=sd(subset.x$RDistance)
  
  hi=qnorm(p=0.975,mean=mu,sd=sd.x)
  lo=qnorm(p=0.025,mean=mu,sd=sd.x)
  
  lows=subset.x[subset.x$RDistance<lo,]
  his=subset.x[subset.x$RDistance>hi,]
  
  lows=lows[order(lows$RDistance,decreasing=F),]
  his=his[order(his$RDistance,decreasing=T),]
  
  #Note that somehow hi and low are switched
  
  print("Higher than Average Counties")
  print(lows[,c("County","State","Population","eBird_count")])
  
  print("Lower than Average Counties")
  print(his[,c("County","State","Population","eBird_count")])
}
```

## Regional Analyses

Second, by subregion:

```{r}
subregions=unique(x$Subregion)

for(i in 1:length(subregions)){

  subset.x=x[x$Subregion==subregions[i],]
  #subset.x=na.omit(subset.x)
  
  eq.x.1=lm(subset.x$logcheck~subset.x$logpop)
  a.1.1=round(coef(eq.x.1)[1],2)#intercept
  b.1.1=round(coef(eq.x.1)[2],6)#slope
  r.x.1=round(summary(eq.x.1)$r.squared,2)
  a.err.1=round(summary(eq.x.1)$coefficients[3],2)
  b.err.1=round(summary(eq.x.1)$coefficients[4],6)

  xval=min(subset.x$logGDP)+(max(subset.x$logpop)-min(subset.x$logpop))/2
  yval=1+max(subset.x$logcheck)
  
  a=ggplot(aes(x=logpop,y=logcheck),data=subset.x)
  b=geom_point()
  c=geom_smooth(method=lm)
  d=theme_classic()
  d.1=theme(axis.title = element_text(face="bold",size=20),
            axis.text = element_text(size=10,face="bold"),
            legend.title = element_blank(),
            legend.text = element_text(size=14,face="bold"))
  w2=ggtitle(subregions[i])
  
  e=labs(x='Log of Population',y='Log of Checklist Count')
  
  Fig3=a+b+c+d+e+d.1+w2
  ggsave(plot=Fig3,filename=paste0(filepath,"Pop-vs-Checklist_region_",subregions[i],".png"),dpi=400)

  plot(Fig3)
  print(paste0('Relationship ', subregions[i],': y=(',
               round(b.1.1,3),'x +/- ',
               round(2*b.err.1,3),') + (',round(a.1.1,3),
               " +/- ",round(2*a.err.1,3),')',', r^2 = ',round(r.x.1,2)))
}
```

# Overview of all data

```{r}
  a=ggplot(aes(x=Population,y=eBird_count),data=x)
  b=geom_point()
  #c=geom_smooth(method=lm)
  d=theme_classic()
  d.1=theme(axis.title = element_text(face="bold",size=20),
            axis.text = element_text(size=10,face="bold"),
            legend.title = element_blank(),
            legend.text = element_text(size=14,face="bold"))
  #w2=ggtitle(subregions[i])
  
  e=labs(x='Population',y='Checklist Count')
  
  Fig3=a+b+d+e+d.1
  
  plot(Fig3)
  #ggsave(Fig3,paste0(filepath,"Non-transformed_pop-checklist.png"),dpi=400)
```